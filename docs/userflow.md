# **Userflow: 좌석 예약 시스템**

## 1. 콘서트 탐색 및 상세 조회 (예매자)

**입력**

*   홈페이지(` / `) 접속
*   콘서트 카드 클릭

**처리 (정책)**

*   `status`가 `published` 상태인 콘서트 목록만 조회하여 노출한다.
*   콘서트 상세 페이지 접근 시, 해당 콘서트의 전체 좌석 수와 현재 `status`가 `reserved`인 좌석 수를 계산하여 잔여 좌석 수를 실시간으로 제공한다.

**출력**

*   홈페이지에 예약 가능한 콘서트 카드 목록 표시
*   콘서트 상세 페이지에 공연 정보, 등급별 가격, 실시간 잔여 좌석 현황 표시

---

## 2. 좌석 선택 및 임시 선점 (예매자)

**입력**

*   콘서트 상세 페이지에서 "예약하기" 버튼 클릭
*   좌석 배치도에서 원하는 좌석 클릭 (선택/해제)
*   "예약하기 (N석 선택)" 버튼 클릭

**처리 (정책)**

*   **좌석 상태 검증**: 사용자가 좌석을 클릭하는 시점에 해당 좌석의 `status`가 `available`인지 실시간으로 확인한다.
*   **임시 선점 (CRITICAL)**:
    *   `available` 상태의 좌석을 선택하면, 해당 좌석의 `status`를 `temporarily_held`로 즉시 변경하고, 선점 만료 시각(`hold_expires_at`, 현재 시각 + 5분)을 기록한다. 이 처리는 **트랜잭션**으로 묶어 데이터 정합성을 보장한다.
    *   다른 사용자가 이미 선점했거나(`temporarily_held`), 예약 완료(`reserved`)된 좌석은 선택할 수 없도록 막고, "이미 선택된 좌석입니다"와 같은 피드백을 제공한다.
*   **선점 자동 해제**: 서버 스케줄러(Cron Job 등)는 주기적으로 `hold_expires_at`이 지난 좌석을 찾아 `status`를 다시 `available`로 변경한다.

**출력**

*   선택한 좌석은 UI에서 시각적으로 구분 (예: 색상 변경)
*   선택한 좌석 정보가 '선택 현황 카드'에 실시간으로 반영
*   선택 실패 시 사용자에게 즉각적인 피드백 메시지 노출
*   성공적으로 좌석 선택 후 다음 버튼 클릭 시 '예약 정보 입력' 페이지로 이동

---

## 3. 예약 정보 입력 및 확정 (예매자)

**입력**

*   예약자 이름, 휴대폰 번호, 비밀번호(예약 조회용) 입력
*   "예약 완료" 버튼 클릭

**처리 (정책)**

*   **입력값 유효성 검사**: 휴대폰 번호 형식, 비밀번호 규칙 등을 검증한다.
*   **선점 유효성 재검증**: 제출 시점에 사용자가 선점한 좌석들의 `hold_expires_at`이 아직 유효한지 다시 확인한다.
*   **예약 확정 (트랜잭션)**:
    1.  `reservations` 테이블에 예약자 정보와 고유 예약 번호로 신규 레코드를 **생성(INSERT)**한다.
    2.  해당 예약에 연결된 좌석들의 `status`를 `temporarily_held`에서 `reserved`로 **갱신(UPDATE)**한다.
    3.  만약 이 과정 중 하나라도 실패하면 전체 트랜잭션을 **롤백(ROLLBACK)**하여 좌석을 `available` 상태로 되돌린다.
*   **비밀번호 암호화**: 입력된 비밀번호는 해시 처리하여 저장한다.

**출력**

*   예약 성공 시, 생성된 예약 ID(`reservationId`)와 함께 '예약 완료' 페이지로 리다이렉트
*   선점 시간이 만료되었거나 처리 중 오류 발생 시, "예약에 실패했습니다" 메시지를 표시하고 좌석 선택 페이지로 돌려보낸다.

---

## 4. 예약 조회 및 취소 (예매자)

**입력**

*   '예약 조회' 페이지 접근
*   휴대폰 번호, 비밀번호 입력 후 "예약 조회" 버튼 클릭
*   예약 내역 상세 페이지에서 "예약 취소" 버튼 클릭

**처리 (정책)**

*   **예약 조회**: 입력된 휴대폰 번호와 암호화된 비밀번호가 `reservations` 테이블의 기록과 일치하는지 확인한다.
*   **예약 취소 정책 (CRITICAL)**:
    *   공연 시작 시간 24시간 전 등, 특정 비즈니스 규칙에 따라 취소 가능 여부를 결정한다. (MVP에서는 상시 취소 가능으로 가정)
    *   **취소 처리 (트랜잭션)**:
        1.  `reservations` 레코드의 `status`를 `cancelled`로 변경하거나, 소프트 삭제(`deleted_at` 기록) 처리한다.
        2.  해당 예약에 연결된 모든 좌석의 `status`를 `reserved`에서 `available`로 **갱신(UPDATE)**하여 다른 사용자가 예약할 수 있도록 한다.

**출력**

*   조회 성공 시, 해당 예약 정보가 담긴 '예약 내역 상세' 페이지 표시
*   조회 실패 시, "일치하는 예약 정보가 없습니다." 메시지 표시
*   취소 성공 시, "예약이 정상적으로 취소되었습니다." 메시지 표시 후 홈으로 이동

---

## 5. 운영 (Operator)

**입력**

*   데이터베이스에 직접 접근하여 공연 및 좌석 정보 CUD(생성, 수정, 삭제) 작업 수행
*   공연 상태 변경 (예: `draft` → `published`)

**처리 (정책)**

*   **데이터 무결성**: 좌석은 반드시 유효한 `concertId`를 가져야 하는 등 Foreign Key 제약 조건을 준수해야 한다.
*   **데이터 삭제 정책**:
    *   모든 데이터는 물리적 `DELETE`를 **금지**하고, `deleted_at` 타임스탬프를 기록하는 **소프트 삭제(Soft Delete)**를 원칙으로 한다.
    *   공연 정보를 비활성화할 경우, `status`를 `archived` 등으로 변경하여 신규 예약은 막되 기존 예약 내역은 보존한다.
*   **상태 관리**: 신규 생성된 공연은 `status=draft`로 시작하며, 운영자가 직접 `published`로 변경해야만 사용자에게 노출된다.

**출력**

*   `status=published`로 변경된 공연은 예매자 UI에 즉시 반영된다.
*   데이터베이스 변경 사항이 시스템 전반의 정보 조회에 일관성 있게 적용된다.